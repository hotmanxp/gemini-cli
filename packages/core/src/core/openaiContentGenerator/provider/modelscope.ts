/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

/* eslint-disable @typescript-eslint/no-unsafe-type-assertion */

import type OpenAI from 'openai';
import type { ContentGeneratorConfig } from '../../contentGenerator.js';
import type { OpenAIContentGeneratorConfig } from '../types.js';
import { DefaultOpenAICompatibleProvider } from './default.js';

/**
 * Provider for ModelScope API
 */
export class ModelScopeOpenAICompatibleProvider extends DefaultOpenAICompatibleProvider {
  /**
   * Checks if the configuration is for ModelScope.
   */
  static isModelScopeProvider(config: ContentGeneratorConfig): boolean {
    const openaiConfig = config as OpenAIContentGeneratorConfig;
    return !!openaiConfig.baseUrl?.includes('modelscope');
  }

  /**
   * ModelScope does not support `stream_options` when `stream` is false.
   * This method removes `stream_options` if `stream` is not true.
   */
  override buildRequest(
    request: OpenAI.Chat.ChatCompletionCreateParams,
    userPromptId: string,
  ): OpenAI.Chat.ChatCompletionCreateParams {
    const newRequest = super.buildRequest(request, userPromptId);
    if (!newRequest.stream) {
      delete newRequest.stream_options;
    }

    return newRequest;
  }
}
